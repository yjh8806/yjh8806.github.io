{"version":3,"sources":["pages/Chat.js"],"names":["SideGrid","styled","div","props","isOpen","Container","Chat","React","useState","setIsOpen","onClick","sock","SockJS","ws","Stomp","over","dispatch","useDispatch","roomName","history","location","state","room_id","post_id","own_user_id","order_time","user_in_chat","useSelector","chat","userInList","sender_nick","user","user_nickname","sender_profile","user_profile","sender_id","user_id","useEffect","logger","userAction","loginCheck","token","chatActions","moveChatRoom","getChatMessagesAX","getChatUserAX","wsConnectSubscribe","wsDisConnectUnsubscribe","customAlert","sweetOK","then","res","replace","debug","connect","subscribe","data","newMessage","JSON","parse","body","now_time","moment","format","getMessages","createdAt","e","disconnect","unsubscribe","clearTimeout","waitForConnection","callback","setTimeout","readyState","messages","messageEndRef","useRef","current","scrollTop","scrollHeight","length","Fragment","ref","shape","align_items","transitions","touch","pullRight","sidebar","_onClick","sendBen","other_user_id","other_user_name","sweetNeedLogin","type","roomId","senderId","message","send","stringify","sweetConfirmReload","sendBreak","open","onSetOpen","sidebarClassName","styles","content","text_align","sendMessage","new_message","sender","senderImg"],"mappings":"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","file":"static/js/9.0354e2a6.chunk.js","sourcesContent":["// 실제 채팅이 이루어지는 채팅방 페이지\nimport React from \"react\";\nimport moment from \"moment\";\nimport logger from \"../shared/Console\";\nimport { token } from \"../shared/OAuth\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { history } from \"../redux/configureStore\";\nimport { actionCreators as chatActions } from \"../redux/modules/chat\";\nimport { actionCreators as userAction } from \"../redux/modules/user\";\n\n// 소켓 통신\nimport Stomp from \"stompjs\";\nimport SockJS from \"sockjs-client\";\n\n// style\nimport styled from \"styled-components\";\nimport Spinner from \"../shared/Spinner\";\nimport {\n  Header,\n  MessageList,\n  MessageWrite,\n  SideContent,\n  PcSide,\n} from \"../components\";\nimport { Grid } from \"../elements\";\nimport { customAlert } from \"../components/Sweet\";\nimport \"../styles/side.css\";\n\n// side bar\nimport Sidebar from \"react-sidebar\";\n\nconst Chat = (props) => {\n  // side bar 열기, 닫기 상태 관리\n  const [isOpen, setIsOpen] = React.useState(false);\n  const onClick = () => {\n    setIsOpen(!isOpen);\n  };\n\n  // 배포, 개발 환경 채팅 주소 관리\n  const env = process.env.NODE_ENV;\n  const devTarget =\n    env === \"development\" ? \"http://115.85.182.57/chatting\" : \"https://gorokke.shop/chatting\";\n  // 소켓\n  const sock = new SockJS(devTarget);\n  const ws = Stomp.over(sock);\n\n  // 현재 방정보\n  // ChatRoomList에서 받아오는 정보\n  // 채팅 목록 조회시 받아온 정보로 특정 채팅방 입장\n  const dispatch = useDispatch();\n  const roomName = props.history.location.state?.roomName;\n  const room_id = props.history.location.state?.room_id;\n  const post_id = props.history.location.state?.post_id;\n  const own_user_id = props.history.location.state?.own_user_id;\n  const order_time = props.history.location.state?.order_time;\n\n  // 채팅 참여 중인 사용자 정보\n  const user_in_chat = useSelector((state) => state.chat?.userInList);\n\n  // 보낼 메세지 정보\n  const sender_nick = useSelector((state) => state.user.user?.user_nickname);\n  const sender_profile = useSelector((state) => state.user.user?.user_profile);\n  const sender_id = useSelector((state) => state.user.user?.user_id);\n\n  // 새로고침될때 방 정보 날아가지 않도록 함\n  React.useEffect(() => {\n    logger(\"chat props\", props);\n    logger(\"chat sender info\", sender_profile);\n    logger(\"chat user_in_chat\", user_in_chat);\n    dispatch(userAction.loginCheck());\n\n    // 리덕스의 현재방 정보 변경\n    if (token) {\n      dispatch(\n        chatActions.moveChatRoom(\n          room_id,\n          roomName,\n          post_id,\n          own_user_id,\n          order_time\n        )\n      );\n      // 이전 대화 기록 불러오기\n      dispatch(chatActions.getChatMessagesAX());\n      // 현재 채팅방 참여 사용자 정보 불러오기\n      dispatch(chatActions.getChatUserAX(room_id));\n    }\n  }, []);\n\n  // 방 정보가 바뀌면 소켓 연결 구독, 구독해제\n  React.useEffect(() => {\n    // 방 정보가 없는 경우 홈으로 돌려보내기\n    if (!room_id) {\n      return customAlert\n        .sweetOK(\n          \"잘못된 접근입니다.\",\n          \"홈으로 돌아갑니다.\",\n          \"채팅 신청 후 채팅탭을 이용해주세요.\",\n          \"확인\"\n        )\n        .then((res) => {\n          return history.replace(\"/home\");\n        });\n    }\n    wsConnectSubscribe();\n    return () => {\n      wsDisConnectUnsubscribe();\n    };\n  }, [room_id ? room_id : null]);\n\n  // 채팅방시작하기, 채팅방 클릭 시 room_id에 해당하는 방을 구독\n  const wsConnectSubscribe = () => {\n    try {\n      ws.debug = null;\n      ws.connect(\n        {\n          token: token,\n        },\n        () => {\n          ws.subscribe(\n            `/sub/api/chat/rooms/${room_id}`,\n            (data) => {\n              const newMessage = JSON.parse(data.body);\n              logger(\"구독후 새로운 메세지 data\", newMessage);\n\n              // 실시간 채팅 시간 넣어주는 부분\n              const now_time = moment().format(\"YYYY-MM-DD HH:mm:ss\");\n              dispatch(\n                chatActions.getMessages({ ...newMessage, createdAt: now_time })\n              );\n            },\n            {\n              token: token,\n            }\n          );\n        }\n      );\n    } catch (e) {\n      logger(\"소켓 커넥트 에러\", e);\n    }\n  };\n\n  // 다른 방을 클릭하거나 뒤로가기 버튼 클릭시 연결해제 및 구독해제\n  const wsDisConnectUnsubscribe = () => {\n    try {\n      ws.debug = null;\n      ws.disconnect(\n        () => {\n          ws.unsubscribe(\"sub-0\");\n          clearTimeout(waitForConnection);\n        },\n        { token: token }\n      );\n    } catch (e) {\n      logger(\"연결 구독 해체 에러\", e);\n    }\n  };\n\n  // 웹소켓이 연결될 때 까지 실행하는 함수\n  const waitForConnection = (ws, callback) => {\n    setTimeout(() => {\n      if (ws.ws.readyState === 1) {\n        callback();\n      } else {\n        waitForConnection(ws, callback);\n      }\n    }, 0.1);\n  };\n\n  const sendMessage = (new_message) => {\n    try {\n      // 토큰없으면 다시 로그인 시키기\n      if (!token) {\n        customAlert.sweetNeedLogin();\n      }\n      // send할 데이터\n      const data = {\n        type: \"TALK\",\n        roomId: room_id,\n        sender: sender_nick,\n        senderImg: sender_profile,\n        senderId: sender_id,\n        message: new_message,\n      };\n      waitForConnection(ws, () => {\n        ws.debug = null;\n\n        ws.send(\"/pub/message\", { token: token }, JSON.stringify(data));\n        logger(\"메세지보내기 상태\", ws.ws.readyState);\n      });\n    } catch (e) {\n      logger(\"message 소켓 함수 에러\", e);\n      logger(\"메세지보내기 상태\", ws.ws.readyState);\n    }\n  };\n\n  // 방장이 악성 유저 강퇴 시키도록 만든 강퇴 함수\n  const sendBen = (other_user_id, other_user_name) => {\n    try {\n      // 토큰없으면 다시 로그인 시키기\n      if (!token) {\n        customAlert.sweetNeedLogin();\n      }\n      // send할 데이터\n      const data = {\n        type: \"BAN\",\n        roomId: room_id,\n        senderId: sender_id,\n        // 강퇴할 사람 user_id\n        message: other_user_id,\n      };\n      waitForConnection(ws, () => {\n        ws.debug = null;\n\n        ws.send(\"/pub/message\", { token: token }, JSON.stringify(data));\n        logger(\"강퇴 메세지 상태\", ws.ws.readyState);\n        customAlert.sweetOK(\n          \"퇴장 처리가 완료되었어요\",\n          `${other_user_name}님을`,\n          `채팅에서 내보냈어요.`,\n          \"\"\n        );\n      });\n    } catch (e) {\n      customAlert.sweetConfirmReload(\n        \"퇴장 처리 실패\",\n        [\"채팅에서 내보내는 데 실패했어요.\", \"잠시 후 다시 시도해주세요.\"],\n        \"\"\n      );\n      logger(\"message 소켓 함수 에러\", e);\n      logger(\"강퇴 메세지 상태\", ws.ws.readyState);\n    }\n  };\n\n  // 방장 채팅방 나가기 함수\n  // 방장이 나가면 채팅방이 사라지고, 글이 삭제 됩니다.\n  const sendBreak = () => {\n    try {\n      // 토큰없으면 다시 로그인 시키기\n      if (!token) {\n        return customAlert.sweetNeedLogin();\n      }\n      // send할 데이터\n      const data = {\n        type: \"BREAK\",\n        roomId: room_id,\n        senderId: sender_id,\n        message: \"방장이 삭제한 채팅방이에요.\",\n      };\n      waitForConnection(ws, () => {\n        ws.debug = null;\n\n        ws.send(\"/pub/message\", { token: token }, JSON.stringify(data));\n        logger(\"방폭 메세지 상태\", ws.ws.readyState);\n      });\n    } catch (e) {\n      customAlert.sweetConfirmReload(\n        \"방 삭제 실패\",\n        [\"방 삭제 요청에 실패했어요.\"],\n        \"\"\n      );\n      logger(\"message 소켓 함수 에러\", e);\n      logger(\"방폭 메세지 상태\", ws.ws.readyState);\n    }\n  };\n\n  // 메세지가 변할 때마다 스크롤 이동시켜주기\n  const messages = useSelector((state) => state.chat.messages);\n\n  // 스크롤 대상\n  const messageEndRef = React.useRef();\n\n  const scrollTomBottom = () => {\n    if (messageEndRef.current) {\n      messageEndRef.current.scrollTop = messageEndRef.current.scrollHeight;\n    }\n  };\n  // 렌더링시 이동\n  React.useEffect(() => {\n    scrollTomBottom();\n    logger(\"tell me you are moving now\", messageEndRef);\n  }, [messages.length]);\n\n  // 방 정보가 없는 경우 \n  if (!room_id) {\n    return (\n      <React.Fragment>\n        <Spinner />\n      </React.Fragment>\n    );\n  } else {\n    return (\n      <React.Fragment>\n        <PcSide {...props} />\n        <Container ref={messageEndRef}>\n          <Grid shape=\"container\" align_items=\"flex-end\">\n            {/* 채팅방 안 사이드 메뉴 창 */}\n            <SideGrid isOpen={isOpen}>\n              <Sidebar\n                transitions={true}\n                touch={true}\n                pullRight={true}\n                sidebar={\n                  <SideContent\n                    own_user_id={own_user_id}\n                    order_time={order_time}\n                    roomName={roomName}\n                    _onClick={onClick}\n                    post_id={post_id}\n                    sendBen={sendBen}\n                    sendBreak={sendBreak}\n                  />\n                }\n                open={isOpen}\n                onSetOpen={setIsOpen}\n                sidebarClassName={isOpen ? \"side-nav active\" : \"side-nav\"}\n                styles={{\n                  content: { text_align: \"right\" },\n                }}\n              >\n              </Sidebar>\n            </SideGrid>\n            <Header\n              {...props}\n              shape=\"채팅방\"\n              roomName={roomName}\n              _onClick={onClick}\n            >\n              {roomName}\n            </Header>\n\n            {/* 메세지 뷰 */}\n            <MessageList />\n            {/* 메세지 보내기 input */}\n            <MessageWrite sendMessage={sendMessage} />\n          </Grid>\n        </Container>\n      </React.Fragment>\n    );\n  }\n};\n\nconst SideGrid = styled.div`\n  position: absolute;\n  width: 30rem;\n  height: 100vh;\n  z-index: 101;\n  text-align: right;\n  display: ${(props) => (props.isOpen ? \"auto\" : \"none\")};\n  touch-action: none;\n`;\n\nconst Container = styled.div`\n  --inputBox: 4.4rem;\n  height: 100vh;\n  margin: 0 auto;\n  background-color: #7b6e62;\n  width: 100%;\n  overflow: scroll;\n\n  &::-webkit-scrollbar {\n    display: none;\n  }\n`;\n\nexport default Chat;\n"],"sourceRoot":""}